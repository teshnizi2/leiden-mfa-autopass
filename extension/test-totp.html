<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOTP Test & Verification</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    label {
      display: block;
      margin: 15px 0 5px 0;
      font-weight: 600;
      color: #333;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .code-display {
      background: #1e1e1e;
      color: #4ec9b0;
      padding: 20px;
      border-radius: 8px;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      font-family: 'Courier New', monospace;
      letter-spacing: 5px;
      margin: 20px 0;
    }
    .timer {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 1s linear;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
    }
    .warning {
      background: #fff3e0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #ff9800;
    }
    .success {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #4caf50;
    }
    .error {
      background: #ffebee;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #f44336;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .clock {
      text-align: center;
      font-size: 18px;
      color: #333;
      margin: 20px 0;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê TOTP Test & Verification</h1>
    <p class="subtitle">Test your TOTP secret key and verify code generation</p>

    <div class="section">
      <h2>üìã Current Configuration</h2>
      <button onclick="loadStoredSecret()">Load Secret from Extension</button>
      <div id="storedSecretDisplay" style="margin-top: 15px;"></div>
    </div>

    <div class="section">
      <h2>üß™ Test TOTP Generation</h2>
      <label for="secretInput">Enter Your TOTP Secret Key:</label>
      <input type="text" id="secretInput" placeholder="JBSWY3DPEHPK3PXP (Base32 format)" />
      <p style="color: #666; font-size: 14px; margin-top: 5px;">
        This should be the same secret key you see in your authenticator app
      </p>
      
      <button onclick="generateAndDisplay()">Generate TOTP Code</button>
      
      <div id="codeOutput" style="display: none;">
        <div class="code-display" id="codeValue">------</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="timer" id="timer">Time remaining: 30s</div>
        <div class="clock" id="clock"></div>
      </div>

      <div id="debugInfo" style="margin-top: 20px;"></div>
    </div>

    <div class="section">
      <h2>üîç Diagnostic Information</h2>
      <button onclick="runDiagnostics()">Run Diagnostics</button>
      <div id="diagnosticsOutput" style="margin-top: 15px;"></div>
    </div>

    <div class="section">
      <h2>üìö Instructions</h2>
      <div class="info">
        <strong>How to verify your secret key:</strong>
        <ol>
          <li>Open your authenticator app (Google Authenticator, Microsoft Authenticator, etc.)</li>
          <li>Find the Leiden University entry</li>
          <li>The 6-digit code in the app should match the code generated here</li>
          <li>If they don't match, your secret key is wrong</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    // Base32 decode function (same as extension)
    function base32Decode(base32) {
      const base32chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      base32 = base32.toUpperCase().replace(/=+$/, '').replace(/\s+/g, '');
      
      if (base32.length === 0) return null;
      
      let bits = 0;
      let value = 0;
      let index = 0;
      const output = new Uint8Array(Math.ceil((base32.length * 5) / 8));
      
      for (let i = 0; i < base32.length; i++) {
        const charIndex = base32chars.indexOf(base32[i]);
        if (charIndex === -1) {
          console.warn(`Invalid base32 character: ${base32[i]}`);
          continue;
        }
        value = (value << 5) | charIndex;
        bits += 5;
        
        if (bits >= 8) {
          output[index++] = (value >>> (bits - 8)) & 255;
          bits -= 8;
        }
      }
      
      return output.slice(0, index);
    }

    function intToBytes(num) {
      const bytes = new Uint8Array(8);
      for (let i = 7; i >= 0; i--) {
        bytes[i] = num & 255;
        num = num >>> 8;
      }
      return bytes;
    }

    async function hmacSha1(key, message) {
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        key,
        { name: 'HMAC', hash: 'SHA-1' },
        false,
        ['sign']
      );
      
      const signature = await crypto.subtle.sign('HMAC', cryptoKey, message);
      return new Uint8Array(signature);
    }

    function dynamicTruncate(hmac, digits) {
      const offset = hmac[hmac.length - 1] & 0x0f;
      const binary = ((hmac[offset] & 0x7f) << 24) |
                     ((hmac[offset + 1] & 0xff) << 16) |
                     ((hmac[offset + 2] & 0xff) << 8) |
                     (hmac[offset + 3] & 0xff);
      
      return binary % Math.pow(10, digits);
    }

    async function generateTOTP(secret, timeStep = 30, digits = 6) {
      try {
        secret = secret.replace(/\s+/g, '').toUpperCase();
        const key = base32Decode(secret);
        
        if (!key || key.length === 0) {
          throw new Error('Invalid secret key - check Base32 format');
        }
        
        const counter = Math.floor(Date.now() / 1000 / timeStep);
        const hmac = await hmacSha1(key, intToBytes(counter));
        const code = dynamicTruncate(hmac, digits);
        
        return {
          code: code.toString().padStart(digits, '0'),
          counter: counter,
          timeRemaining: timeStep - (Math.floor(Date.now() / 1000) % timeStep)
        };
      } catch (error) {
        throw error;
      }
    }

    let updateInterval;

    async function generateAndDisplay() {
      const secret = document.getElementById('secretInput').value.trim();
      
      if (!secret) {
        document.getElementById('debugInfo').innerHTML = '<div class="error">‚ö†Ô∏è Please enter a secret key</div>';
        return;
      }

      try {
        const result = await generateTOTP(secret);
        
        document.getElementById('codeOutput').style.display = 'block';
        document.getElementById('codeValue').textContent = result.code;
        
        // Clear previous interval
        if (updateInterval) clearInterval(updateInterval);
        
        // Update timer and progress bar
        updateInterval = setInterval(async () => {
          const now = Math.floor(Date.now() / 1000);
          const timeRemaining = 30 - (now % 30);
          const progress = (timeRemaining / 30) * 100;
          
          document.getElementById('timer').textContent = `Time remaining: ${timeRemaining}s`;
          document.getElementById('progressBar').style.width = progress + '%';
          document.getElementById('clock').textContent = new Date().toLocaleTimeString();
          
          // Regenerate code when timer hits 0
          if (timeRemaining === 30) {
            const newResult = await generateTOTP(secret);
            document.getElementById('codeValue').textContent = newResult.code;
          }
        }, 1000);
        
        document.getElementById('debugInfo').innerHTML = `
          <div class="success">
            <strong>‚úÖ TOTP Generated Successfully</strong>
            <pre>Code: ${result.code}
Counter: ${result.counter}
Time remaining: ${result.timeRemaining}s
Secret length: ${secret.length} characters</pre>
            <p><strong>Compare this code with your authenticator app!</strong></p>
          </div>
        `;
        
      } catch (error) {
        document.getElementById('debugInfo').innerHTML = `
          <div class="error">
            <strong>‚ùå Error:</strong> ${error.message}
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    }

    function loadStoredSecret() {
      chrome.storage.sync.get(['totpSecret'], (result) => {
        if (result.totpSecret) {
          document.getElementById('storedSecretDisplay').innerHTML = `
            <div class="success">
              <strong>Secret Key Found:</strong>
              <pre>${result.totpSecret}</pre>
              <button onclick="document.getElementById('secretInput').value = '${result.totpSecret}'; generateAndDisplay();">
                Test This Secret
              </button>
            </div>
          `;
        } else {
          document.getElementById('storedSecretDisplay').innerHTML = `
            <div class="warning">
              ‚ö†Ô∏è No secret key configured. Please go to extension settings and add your TOTP secret.
            </div>
          `;
        }
      });
    }

    function runDiagnostics() {
      const now = new Date();
      const timestamp = Math.floor(Date.now() / 1000);
      const counter = Math.floor(timestamp / 30);
      const timeInWindow = timestamp % 30;
      
      document.getElementById('diagnosticsOutput').innerHTML = `
        <div class="info">
          <strong>üîç System Diagnostics:</strong>
          <pre>Current time: ${now.toLocaleString()}
Unix timestamp: ${timestamp}
TOTP counter: ${counter}
Time in current window: ${timeInWindow}s / 30s
Next code in: ${30 - timeInWindow}s

Time zone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}
Time zone offset: UTC${now.getTimezoneOffset() > 0 ? '-' : '+'}${Math.abs(now.getTimezoneOffset() / 60)}</pre>
        </div>
        <div class="warning">
          <strong>‚ö†Ô∏è Common Issues:</strong>
          <ul>
            <li><strong>Wrong secret:</strong> Make sure you copied the entire Base32 secret</li>
            <li><strong>Time sync:</strong> Your computer clock must be accurate (within ~30 seconds)</li>
            <li><strong>Spaces/formatting:</strong> Remove any spaces or dashes from the secret</li>
          </ul>
        </div>
      `;
    }

    // Auto-load on page load
    window.onload = () => {
      loadStoredSecret();
      runDiagnostics();
    };
  </script>
</body>
</html>
